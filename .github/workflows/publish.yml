name: Publish to Maven Central

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 5.0.6) - must match pom.xml"
        type: string
        required: true
      draft:
        description: "Create GitHub release as draft"
        type: boolean
        required: false
        default: false

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          server-id: central
          server-username: CENTRAL_USERNAME
          server-password: CENTRAL_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Resolve version
        id: version
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            if [[ -z "${INPUT_VERSION:-}" ]]; then
              echo "::error::Version input is required for manual trigger."
              exit 1
            fi
            VERSION="${INPUT_VERSION}"
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              echo "::error::Invalid version format. Expected: X.Y.Z (e.g. 5.0.6)"
              exit 1
            fi
            TAG_NAME="v${VERSION}"
          else
            TAG_NAME="${GITHUB_REF_NAME}"
            if [[ ! "$TAG_NAME" =~ ^v[0-9] ]]; then
              echo "::error::Tag must start with v followed by version (e.g. v5.0.6)."
              exit 1
            fi
            VERSION="${TAG_NAME#v}"
          fi

          # Verify pom.xml version matches
          POM_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          if [[ "$POM_VERSION" != "$VERSION" ]]; then
            echo "::error::pom.xml version ($POM_VERSION) does not match release version ($VERSION)"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "TAG_NAME=$TAG_NAME" >> "$GITHUB_ENV"
          echo "Resolved version: $VERSION (matches pom.xml)"

      - name: Publish to Maven Central
        run: mvn -B -ntp clean deploy -Prelease
        env:
          CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: v${{ steps.version.outputs.version }}
          draft: ${{ inputs.draft || false }}
          generate_release_notes: true
          files: |
            target/ckeditor-vaadin-${{ steps.version.outputs.version }}.jar
            target/ckeditor-vaadin-${{ steps.version.outputs.version }}-sources.jar
            target/ckeditor-vaadin-${{ steps.version.outputs.version }}-javadoc.jar
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job Summary
        if: always()
        run: |
          {
            echo "## Release Summary"
            echo ""
            echo "| Parameter | Value |"
            echo "|-----------|-------|"
            echo "| Version | \`${VERSION:-n/a}\` |"
            echo "| Tag | \`${TAG_NAME:-n/a}\` |"
            echo "| Maven Central | \`com.wontlost:ckeditor-vaadin:${VERSION:-n/a}\` |"
            echo "| Status | \`${{ job.status }}\` |"
            echo ""
            if [[ "${{ job.status }}" == "success" ]]; then
              echo "Published to [Maven Central](https://central.sonatype.com/artifact/com.wontlost/ckeditor-vaadin/${VERSION})"
              echo ""
              echo "Released to [GitHub Releases](https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME})"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
